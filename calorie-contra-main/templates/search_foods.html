{% extends "layout.html" %}

{% block title %}
Search Results - {{ query or "Food Search" }}
{% endblock %}

{% block main %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --card-shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.15);
        --border-radius: 16px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .search-results-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .results-header {
        text-align: center;
        margin-bottom: 3rem;
        position: relative;
    }

    .results-title {
        font-size: 2.5rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
        line-height: 1.2;
    }

    .results-subtitle {
        color: #64748b;
        font-size: 1.1rem;
        font-weight: 500;
    }

    .query-highlight {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 50px;
        color: #4f46e5;
        font-weight: 600;
        margin: 0 0.5rem;
    }

    /* Modern Tab Styling */
    .modern-tabs {
        background: white;
        border-radius: var(--border-radius);
        padding: 0.5rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        border: none;
    }

    .modern-tab {
        flex: 1;
        min-width: 120px;
        padding: 0.75rem 1.5rem;
        border: none;
        background: transparent;
        color: #64748b;
        font-weight: 600;
        font-size: 0.9rem;
        border-radius: 12px;
        transition: var(--transition);
        cursor: pointer;
        white-space: nowrap;
        position: relative;
        overflow: hidden;
    }

    .modern-tab:hover {
        color: #4f46e5;
        background: rgba(102, 126, 234, 0.05);
    }

    .modern-tab.active {
        background: var(--primary-gradient);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    /* Food Cards Grid */
    .foods-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .food-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
    }

    .food-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--card-shadow-hover);
    }

    .food-card-header {
        padding: 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        position: relative;
    }

    .food-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .food-category {
        color: #64748b;
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .category-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .nutrition-preview {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        padding: 1rem 1.5rem;
        background: #f8fafc;
    }

    .nutrient-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.75rem;
        background: white;
        border-radius: 12px;
        transition: var(--transition);
    }

    .nutrient-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .nutrient-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }

    .nutrient-label {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .food-actions {
        padding: 1rem 1.5rem;
        display: flex;
        gap: 0.75rem;
    }

    .quick-info-btn {
        flex: 1;
        padding: 0.75rem 1rem;
        background: rgba(102, 126, 234, 0.1);
        color: #4f46e5;
        border: 2px solid rgba(102, 126, 234, 0.2);
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: var(--transition);
        cursor: pointer;
    }

    .quick-info-btn:hover {
        background: rgba(102, 126, 234, 0.2);
        border-color: rgba(102, 126, 234, 0.4);
        transform: translateY(-1px);
    }

    .view-details-btn {
        flex: 2;
        padding: 0.75rem 1.5rem;
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: var(--transition);
        cursor: pointer;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .view-details-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        color: white;
        text-decoration: none;
    }

    /* Modern Loader */
    .modern-loader {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .loader-content {
        text-align: center;
    }

    .loader-spinner {
        width: 60px;
        height: 60px;
        margin: 0 auto 1.5rem;
        border: 4px solid #f1f5f9;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loader-text {
        color: #4f46e5;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .loader-subtext {
        color: #64748b;
        font-size: 0.9rem;
    }

    /* Modern Pagination */
    .modern-pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 3rem;
    }

    .page-btn {
        padding: 0.75rem 1rem;
        background: white;
        color: #64748b;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: var(--transition);
        cursor: pointer;
        text-decoration: none;
        min-width: 45px;
        text-align: center;
    }

    .page-btn:hover {
        color: #4f46e5;
        border-color: #4f46e5;
        background: rgba(79, 70, 229, 0.05);
        text-decoration: none;
    }

    .page-btn.active {
        background: var(--primary-gradient);
        color: white;
        border-color: transparent;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .search-results-container {
            padding: 1rem 0.5rem;
        }

        .results-title {
            font-size: 2rem;
        }

        .foods-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .modern-tabs {
            flex-wrap: wrap;
        }

        .modern-tab {
            min-width: 100px;
            font-size: 0.8rem;
        }

        .nutrition-preview {
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .food-actions {
            flex-direction: column;
            gap: 0.5rem;
        }
    }

    /* Enhanced Popover Styling */
    .popover {
        border-radius: 16px;
        border: none;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .popover-header {
        background: var(--primary-gradient);
        color: white;
        border-radius: 16px 16px 0 0;
        font-weight: 600;
    }

    .popover-body {
        padding: 1rem;
    }

    /* Animation Classes */
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .slide-up {
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<div class="search-results-container">
    <div class="results-header fade-in">
        <h1 class="results-title">
            Search Results for 
            <span class="query-highlight">{{ query or "All Foods" }}</span>
        </h1>
        <p class="results-subtitle">Discover nutritional information from the USDA database</p>
    </div>

    <div class="modern-tabs" role="tablist">
        <button class="modern-tab active" role="tab" data-category="All">
            <i class="fas fa-globe me-1"></i>All
        </button>
        <button class="modern-tab" role="tab" data-category="Branded">
            <i class="fas fa-tag me-1"></i>Branded
        </button>
        <button class="modern-tab" role="tab" data-category="Foundation">
            <i class="fas fa-seedling me-1"></i>Foundation
        </button>
        <button class="modern-tab" role="tab" data-category="Survey (FNDDS)">
            <i class="fas fa-chart-bar me-1"></i>Survey
        </button>
        <button class="modern-tab" role="tab" data-category="SR Legacy">
            <i class="fas fa-archive me-1"></i>Legacy
        </button>
    </div>

    <div class="foods-grid" id="foods-container"></div>

    <div class="modern-loader" id="loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">Searching Database</div>
            <div class="loader-subtext">Finding the best nutritional matches...</div>
        </div>
    </div>

    <nav class="modern-pagination" id="pagination-container" aria-label="Search results pagination">
        <!-- Pagination will be dynamically generated -->
    </nav>
</div>

<script>
    const getEl = (element) => document.querySelector(element);
    const getAllEl = (element) => document.querySelectorAll(element);

    // Global state variables   
    const query = "{{ query }}";
    let page = 1;
    const dataType = [];

    // Obtain elements
    const $foodsContainer = getEl("#foods-container");
    const $navTabs = getAllEl(".modern-tab");
    const $loader = getEl('#loader');
    const $pagination = getEl("#pagination-container");

    const nutrientNumbers = {
        protein: 203,
        fat: 204,
        carbs: 205,
        calories: 208,
    };

    function addEventListener() {
        $navTabs.forEach(tab => {
            tab.addEventListener("click", selectTab);
        });
    }

    async function selectTab(event) {
        event.preventDefault();
        
        // Remove active class from all tabs
        $navTabs.forEach(tab => tab.classList.remove("active"));
        
        // Add active class to clicked tab
        event.target.classList.add("active");
        
        // Set data type
        dataType[0] = event.target.getAttribute('data-category');
        
        // Reset page to 1 when switching tabs
        page = 1;
        
        const data = await fetchFoodData(dataType);
        if (data) {
            renderFoodData(data);
            renderPagination(data.totalPages);
            initializePopovers();
        }
    }

    async function fetchFoodData(dataType = []) {
        $foodsContainer.innerHTML = '';
        $loader.style.display = "flex";
        
        try {
            const baseUrl = `/api/search_foods?query=${query}`;
            const pageParam = `&page=${page}`;
            const dataTypeParam = dataType.length === 0 || dataType.includes("All") ? "" : `&dataType=${dataType}`;
            const url = `${baseUrl}${dataTypeParam}${pageParam}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error("Error:", error);
            return null;
        } finally {
            $loader.style.display = "none";
        }
    }

    function handlePaginationClick(event) {
        event.preventDefault();
        const pageNum = parseInt(event.target.textContent);
        
        if (isNaN(pageNum)) return;
        
        page = pageNum;
        
        fetchFoodData(dataType).then(data => {
            if (data) {
                renderFoodData(data);
                renderPagination(data.totalPages);
                initializePopovers();
                
                // Update active pagination button
                getAllEl('.page-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                // Smooth scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    }

    function renderPagination(totalPages) {
        $pagination.innerHTML = '';
        
        // Previous button
        if (page > 1) {
            const prevBtn = document.createElement('a');
            prevBtn.className = 'page-btn';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.addEventListener('click', (e) => {
                e.preventDefault();
                page--;
                fetchFoodData(dataType).then(data => {
                    if (data) {
                        renderFoodData(data);
                        renderPagination(data.totalPages);
                        initializePopovers();
                    }
                });
            });
            $pagination.appendChild(prevBtn);
        }
        
        // Page numbers
        const startPage = Math.max(1, page - 2);
        const endPage = Math.min(totalPages, page + 2);
        
        for (let p = startPage; p <= endPage; p++) {
            const pageBtn = document.createElement('a');
            pageBtn.className = `page-btn ${p === page ? 'active' : ''}`;
            pageBtn.textContent = p;
            pageBtn.addEventListener('click', handlePaginationClick);
            $pagination.appendChild(pageBtn);
        }
        
        // Next button
        if (page < totalPages) {
            const nextBtn = document.createElement('a');
            nextBtn.className = 'page-btn';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.addEventListener('click', (e) => {
                e.preventDefault();
                page++;
                fetchFoodData(dataType).then(data => {
                    if (data) {
                        renderFoodData(data);
                        renderPagination(data.totalPages);
                        initializePopovers();
                    }
                });
            });
            $pagination.appendChild(nextBtn);
        }
    }

    function renderFoodData(data) {
        const { foods } = data;
        
        const results = foods.map(food => {
            const { foodCategory, description, foodNutrients } = food;
            
            const nutrients = {
                calories: foodNutrients.find(n => Number(n.nutrientNumber) === nutrientNumbers.calories)?.value || "N/A",
                protein: foodNutrients.find(n => Number(n.nutrientNumber) === nutrientNumbers.protein)?.value || "N/A",
                fat: foodNutrients.find(n => Number(n.nutrientNumber) === nutrientNumbers.fat)?.value || "N/A",
                carbs: foodNutrients.find(n => Number(n.nutrientNumber) === nutrientNumbers.carbs)?.value || "N/A",
            };

            return `
                <div class="food-card slide-up">
                    <div class="food-card-header">
                        <h3 class="food-title">${description}</h3>
                        <div class="food-category">
                            <span class="category-badge">${foodCategory || 'General'}</span>
                        </div>
                    </div>
                    <div class="nutrition-preview">
                        <div class="nutrient-item">
                            <div class="nutrient-value">${nutrients.calories !== "N/A" ? Math.round(nutrients.calories) : "N/A"}</div>
                            <div class="nutrient-label">Calories</div>
                        </div>
                        <div class="nutrient-item">
                            <div class="nutrient-value">${nutrients.protein !== "N/A" ? Math.round(nutrients.protein * 10) / 10 : "N/A"}</div>
                            <div class="nutrient-label">Protein (g)</div>
                        </div>
                        <div class="nutrient-item">
                            <div class="nutrient-value">${nutrients.carbs !== "N/A" ? Math.round(nutrients.carbs * 10) / 10 : "N/A"}</div>
                            <div class="nutrient-label">Carbs (g)</div>
                        </div>
                        <div class="nutrient-item">
                            <div class="nutrient-value">${nutrients.fat !== "N/A" ? Math.round(nutrients.fat * 10) / 10 : "N/A"}</div>
                            <div class="nutrient-label">Fat (g)</div>
                        </div>
                    </div>
                    <div class="food-actions">
                        <button type="button" class="quick-info-btn" data-bs-toggle="popover" 
                                data-bs-title="Complete Nutrition Facts" 
                                data-bs-content='
                                    <div class="nutrition-details">
                                        <div class="row mb-2">
                                            <div class="col-6"><strong>Calories:</strong></div>
                                            <div class="col-6">${nutrients.calories !== "N/A" ? Math.round(nutrients.calories) + " kcal" : "N/A"}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6"><strong>Protein:</strong></div>
                                            <div class="col-6">${nutrients.protein !== "N/A" ? Math.round(nutrients.protein * 10) / 10 + "g" : "N/A"}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6"><strong>Carbs:</strong></div>
                                            <div class="col-6">${nutrients.carbs !== "N/A" ? Math.round(nutrients.carbs * 10) / 10 + "g" : "N/A"}</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6"><strong>Fat:</strong></div>
                                            <div class="col-6">${nutrients.fat !== "N/A" ? Math.round(nutrients.fat * 10) / 10 + "g" : "N/A"}</div>
                                        </div>
                                    </div>'>
                            <i class="fas fa-info-circle me-1"></i>Quick Info
                        </button>
                        <a href="/food/${food.fdcId}" class="view-details-btn">
                            <i class="fas fa-eye me-1"></i>View Details
                        </a>
                    </div>
                </div>
            `;
        }).join("");

        $foodsContainer.innerHTML = results;
    }

    function initializePopovers() {
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.forEach(popoverTriggerEl => {
            new bootstrap.Popover(popoverTriggerEl, {
                html: true,
                trigger: 'hover focus',
                placement: 'top'
            });
        });
    }

    async function init() {
        const data = await fetchFoodData();
        
        if (data) {
            renderFoodData(data);
            renderPagination(data.totalPages);
            initializePopovers();
        }
        addEventListener();
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}
