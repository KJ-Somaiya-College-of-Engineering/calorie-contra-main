{% extends "layout.html" %}

{% block title %}
Nutrition Facts - {{ food.description }}
{% endblock %}

{% block main %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --card-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        --card-shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.15);
        --border-radius: 20px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        min-height: 100vh;
    }

    .nutrition-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .food-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
    }

    .food-title {
        font-size: 2.5rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
        line-height: 1.2;
    }

    .serving-controls {
        background: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }

    .serving-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .serving-row {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
    }

    .serving-input {
        flex: 1;
        max-width: 200px;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 500;
        transition: var(--transition);
    }

    .serving-input:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .serving-select {
        flex: 2;
        max-width: 300px;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 500;
        transition: var(--transition);
        background: white;
    }

    .serving-select:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .add-log-btn {
        padding: 0.75rem 2rem;
        background: var(--success-gradient);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        transition: var(--transition);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-log-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
    }

    .nutrition-label {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .label-header {
        background: var(--primary-gradient);
        color: white;
        padding: 2rem;
        text-align: center;
    }

    .label-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
    }

    .serving-info {
        padding: 1.5rem 2rem;
        border-bottom: 3px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .calories-section {
        padding: 1.5rem 2rem;
        border-bottom: 8px solid #1e293b;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .calories-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .calories-label {
        font-size: 1.1rem;
        color: #64748b;
        margin: 0;
    }

    .calories-main {
        font-size: 1.5rem;
        color: #1e293b;
        font-weight: 400;
        margin: 0;
    }

    .calories-value {
        font-size: 3rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .daily-values-header {
        padding: 1rem 2rem 0.5rem;
        text-align: right;
        font-weight: 600;
        color: #64748b;
        font-size: 0.9rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .nutrient-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 2rem;
        border-bottom: 1px solid #e2e8f0;
        transition: var(--transition);
    }

    .nutrient-row:hover {
        background: #f8fafc;
    }

    .nutrient-row.indent {
        padding-left: 3rem;
    }

    .nutrient-row.double-indent {
        padding-left: 4rem;
    }

    .nutrient-name {
        font-weight: 600;
        color: #1e293b;
    }

    .nutrient-amount {
        color: #64748b;
        font-weight: 500;
    }

    .daily-value {
        font-weight: 600;
        color: #4f46e5;
        min-width: 50px;
        text-align: right;
    }

    .thick-divider {
        height: 8px;
        background: #1e293b;
        border: none;
        margin: 0;
    }

    .medium-divider {
        height: 4px;
        background: #64748b;
        border: none;
        margin: 0;
    }

    .vitamins-section {
        padding: 1rem 2rem;
        background: #f8fafc;
    }

    .vitamins-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 0.5rem;
    }

    .daily-values-note {
        padding: 1.5rem 2rem;
        background: #f1f5f9;
        color: #64748b;
        font-size: 0.85rem;
        line-height: 1.4;
        border-top: 2px solid #e2e8f0;
    }

    .reference-table {
        width: 100%;
        margin-top: 1rem;
        border-collapse: collapse;
        font-size: 0.8rem;
    }

    .reference-table th,
    .reference-table td {
        padding: 0.5rem;
        text-align: center;
        border: 1px solid #e2e8f0;
    }

    .reference-table th {
        background: #f1f5f9;
        font-weight: 600;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .nutrition-container {
            padding: 1rem 0.5rem;
        }

        .food-title {
            font-size: 2rem;
        }

        .serving-row {
            flex-direction: column;
            align-items: stretch;
        }

        .serving-input,
        .serving-select {
            max-width: none;
        }

        .nutrient-row {
            padding: 0.75rem 1rem;
        }

        .nutrient-row.indent {
            padding-left: 1.5rem;
        }

        .nutrient-row.double-indent {
            padding-left: 2rem;
        }

        .calories-value {
            font-size: 2.5rem;
        }
    }

    /* Success Animation */
    @keyframes success-pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .success-animation {
        animation: success-pulse 0.3s ease-in-out;
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<div class="nutrition-container">
    <!-- Food Header -->
    <div class="food-header">
        <h1 class="food-title" id="food-description">{{ food.description }}</h1>
    </div>

    <!-- Serving Controls -->
    <div class="serving-controls">
        <h2 class="serving-title">Customize Your Serving Size</h2>
        <form class="serving-form" action="/food-log" method="post" onsubmit="handleLogSubmit(event)">
            <div class="serving-row">
                <input class="serving-input" id="serving-size-input" name="calories" 
                       placeholder="Serving Size" type="number" min="1" 
                       oninput="updateNutrientValues(this.value)">
                
                <select class="serving-select form-select form-select-sm">
                    {% for portion in food.foodPortions %}
                    <option value="{{ portion.gramWeight }}">{{ portion.portionDescription }} ({{ portion.gramWeight }}g)</option>
                    {% endfor %}
                    {% if food.servingSize %}
                    <option value="{{ food.servingSize }}">{{ food.servingSize }}{{ food.servingSizeUnit}} </option>
                    {% endif %}
                    <option value="100">100g</option>
                </select>

                <button class="add-log-btn" type="submit">
                    <i class="fas fa-plus-circle"></i>
                    Add to Log
                </button>
            </div>
        </form>
    </div>

    <!-- Modern Nutrition Label -->
    <div class="nutrition-label">
        <!-- Header -->
        <div class="label-header">
            <h2 class="label-title">Nutrition Facts</h2>
        </div>

        <!-- Serving Info -->
        <div class="serving-info">
            <span>Serving size</span>
            <span id="current-serving">100g</span>
        </div>

        <!-- Calories Section -->
        <div class="calories-section">
            <div class="calories-row">
                <div>
                    <p class="calories-label">Amount per serving</p>
                    <p class="calories-main">Calories</p>
                </div>
                <p class="calories-value" data-nutrient-number="208" id="energy">0</p>
            </div>
        </div>

        <!-- Daily Values Header -->
        <div class="daily-values-header">
            % Daily Value *
        </div>

        <!-- Macronutrients -->
        <div class="nutrient-row">
            <span class="nutrient-name">Total Fat <span class="nutrient-amount" data-nutrient-number="204">0g</span></span>
            <span class="daily-value"></span>
        </div>
        
        <div class="nutrient-row indent">
            <span class="nutrient-name">Saturated Fat <span class="nutrient-amount" data-nutrient-number="606">0g</span></span>
            <span class="daily-value"></span>
        </div>
        
        <div class="nutrient-row indent">
            <span class="nutrient-name"><em>Trans</em> Fat <span class="nutrient-amount" data-nutrient-number="605">0g</span></span>
            <span class="daily-value"></span>
        </div>

        <div class="nutrient-row">
            <span class="nutrient-name">Cholesterol <span class="nutrient-amount" data-nutrient-number="601">0mg</span></span>
            <span class="daily-value"></span>
        </div>

        <div class="nutrient-row">
            <span class="nutrient-name">Sodium <span class="nutrient-amount" data-nutrient-number="307">0mg</span></span>
            <span class="daily-value"></span>
        </div>

        <div class="nutrient-row">
            <span class="nutrient-name">Total Carbohydrate <span class="nutrient-amount" data-nutrient-number="205">0g</span></span>
            <span class="daily-value"></span>
        </div>

        <div class="nutrient-row indent">
            <span class="nutrient-name">Dietary Fiber <span class="nutrient-amount" data-nutrient-number="291">0g</span></span>
            <span class="daily-value"></span>
        </div>

        <div class="nutrient-row indent">
            <span class="nutrient-name">Total Sugars <span class="nutrient-amount" data-nutrient-number="269">0g</span></span>
            <span class="daily-value"></span>
        </div>

        <hr class="thick-divider">

        <div class="nutrient-row">
            <span class="nutrient-name">Protein <span class="nutrient-amount" data-nutrient-number="203">0g</span></span>
            <span class="daily-value"></span>
        </div>

        <hr class="medium-divider">

        <!-- Vitamins & Minerals -->
        <div class="vitamins-section">
            <div class="vitamins-grid">
                <div class="nutrient-row">
                    <span class="nutrient-name">Vitamin A <span class="nutrient-amount" data-nutrient-number="318">0mcg</span></span>
                    <span class="daily-value"></span>
                </div>
                <div class="nutrient-row">
                    <span class="nutrient-name">Vitamin C <span class="nutrient-amount" data-nutrient-number="401">0mg</span></span>
                    <span class="daily-value"></span>
                </div>
                <div class="nutrient-row">
                    <span class="nutrient-name">Calcium <span class="nutrient-amount" data-nutrient-number="301">0mg</span></span>
                    <span class="daily-value"></span>
                </div>
                <div class="nutrient-row">
                    <span class="nutrient-name">Iron <span class="nutrient-amount" data-nutrient-number="303">0mg</span></span>
                    <span class="daily-value"></span>
                </div>
                <div class="nutrient-row">
                    <span class="nutrient-name">Potassium <span class="nutrient-amount" data-nutrient-number="306">0mg</span></span>
                    <span class="daily-value"></span>
                </div>
                <div class="nutrient-row">
                    <span class="nutrient-name">Zinc <span class="nutrient-amount" data-nutrient-number="309">0mg</span></span>
                    <span class="daily-value"></span>
                </div>
            </div>
        </div>

        <!-- Daily Values Note -->
        <div class="daily-values-note">
            <p><strong>*</strong> Percent Daily Values are based on a 2,000 calorie diet. Your daily values may be higher or lower depending on your calorie needs:</p>
            
            <table class="reference-table">
                <thead>
                    <tr>
                        <th colspan="2"></th>
                        <th>Calories: 2,000</th>
                        <th>Calories: 2,500</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Total Fat</th>
                        <td>Less than</td>
                        <td>65g</td>
                        <td>80g</td>
                    </tr>
                    <tr>
                        <th>Saturated Fat</th>
                        <td>Less than</td>
                        <td>20g</td>
                        <td>25g</td>
                    </tr>
                    <tr>
                        <th>Cholesterol</th>
                        <td>Less than</td>
                        <td>300mg</td>
                        <td>300mg</td>
                    </tr>
                    <tr>
                        <th>Sodium</th>
                        <td>Less than</td>
                        <td>2,400mg</td>
                        <td>2,400mg</td>
                    </tr>
                    <tr>
                        <th>Total Carbohydrate</th>
                        <td></td>
                        <td>300g</td>
                        <td>375g</td>
                    </tr>
                    <tr>
                        <th>Dietary Fiber</th>
                        <td></td>
                        <td>25g</td>
                        <td>30g</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const getEl = element => document.querySelector(element);
    const $selectMenu = getEl(".serving-select");
    const $servingSizeInput = getEl('#serving-size-input');
    
    const foodNutrients = {{ food.foodNutrients | tojson }};

    const dailyValues = {
        "Added Sugars": 50, "Biotin": 0.00003, "Calcium": 1.3, "Chloride": 2.3,
        "Choline": 0.55, "Cholesterol": 0.3, "Chromium": 0.000035, "Copper": 0.0009,
        "Dietary Fiber": 28, "Fat": 78, "Folate/Folic Acid": 0.0004, "Iodine": 0.00015,
        "Iron": 0.018, "Magnesium": 0.42, "Manganese": 0.0023, "Molybdenum": 0.000045,
        "Niacin": 0.016, "Pantothenic Acid": 0.005, "Phosphorus": 1.25, "Potassium": 4.7,
        "Protein": 50, "Riboflavin": 0.0013, "Saturated Fat": 20, "Selenium": 0.000055,
        "Sodium": 2.3, "Thiamin": 0.0012, "Total Carbohydrate": 275, "Vitamin A": 0.0009,
        "Vitamin B6": 0.0017, "Vitamin B12": 0.0000024, "Vitamin C": 0.09,
        "Vitamin D": 0.00002, "Vitamin E": 0.015, "Vitamin K": 0.00012, "Zinc": 0.011
    };

    const nutrientNameMapping = {
        "Calcium, Ca": "Calcium", "Cholesterol": "Cholesterol", "Total lipid (fat)": "Fat",
        "Iron, Fe": "Iron", "Potassium, K": "Potassium", "Protein": "Protein",
        "Sodium, Na": "Sodium", "Carbohydrate, by difference": "Total Carbohydrate",
        "Vitamin A, RAE": "Vitamin A", "Vitamin C, total ascorbic acid": "Vitamin C",
        "Zinc, Zn": "Zinc", "Dietary Fiber": "Dietary Fiber"
    };

    window.updateNutrientValues = (selectedValue) => {
        getEl('#current-serving').textContent = selectedValue + 'g';
        
        foodNutrients.forEach(n => {
            const { amount, nutrient } = n;
            let amountPerServing = ((amount * selectedValue) / 100).toFixed(2);
            const nutrientKey = nutrientNameMapping[nutrient?.name];
            const dailyValue = dailyValues[nutrientKey];

            if (nutrient?.unitName === 'mg') {
                amountPerServing = (amountPerServing / 1000).toFixed(2);
            } else if (nutrient?.unitName === "µg") {
                amountPerServing = (amountPerServing / 1000000).toFixed(2);
            }

            const dailyValuePercentage = dailyValue ? parseInt((amountPerServing / dailyValue) * 100) : '';
            const $nutrientElement = getEl(`[data-nutrient-number="${nutrient?.number}"]`);

            if ($nutrientElement) {
                if (parseInt(nutrient?.number) === 208) {
                    $nutrientElement.textContent = parseInt(amountPerServing);
                    return;
                }
                
                $nutrientElement.textContent = amountPerServing + (nutrient?.unitName || '');
                
                const row = $nutrientElement.closest('.nutrient-row');
                if (row) {
                    const dailyValueEl = row.querySelector('.daily-value');
                    if (dailyValueEl && dailyValuePercentage) {
                        dailyValueEl.textContent = dailyValuePercentage + '%';
                    }
                }
            }
        });
    };

    // Initialize with default serving size
    updateNutrientValues($selectMenu.value);

    $selectMenu.addEventListener('change', function (event) {
        const selectedValue = event.target.value;
        $servingSizeInput.value = selectedValue;
        updateNutrientValues(selectedValue);
    });

    window.handleLogSubmit = (event) => {
        event.preventDefault();
        
        if ($servingSizeInput.value === '' || isNaN($servingSizeInput.value) || Number($servingSizeInput.value) <= 0) {
            alert('Please enter a valid serving size');
            return;
        }

        const button = event.target.querySelector('.add-log-btn');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        button.disabled = true;

        const extractNumber = (text) => {
            let match = text.match(/^(\d*\.?\d+)(.*)/);
            return match ? parseFloat(match[1]) : 0;
        };

        fetch('/food-log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                food: getEl('#food-description').textContent,
                calories: extractNumber(getEl('[data-nutrient-number="208"]').textContent),
                carbs: extractNumber(getEl('[data-nutrient-number="205"]').textContent),
                fat: extractNumber(getEl('[data-nutrient-number="204"]').textContent),
                protein: extractNumber(getEl('[data-nutrient-number="203"]').textContent),
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === 'success') {
                button.innerHTML = '<i class="fas fa-check-circle"></i> Added Successfully!';
                button.classList.add('success-animation');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    button.classList.remove('success-animation');
                }, 2000);
            } else {
                throw new Error(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while logging the food');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    };
</script>
{% endblock %}
